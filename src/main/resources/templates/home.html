<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>

    <style type="text/CSS">
        div.row{
            margin:1rem
        }
        div.card{
            padding:1rem
        }
        .marginAbajo{
            margin: 0 0 1rem 0 
        }
        .result{
            display: block;
            position: sticky;
            bottom: 0;
            height: 30rem;
            overflow: scroll;
        }
        .todo {
            color:red;
        }
    </style>

    <title>Endpoints</title>

    <script>
        var app = angular.module("myApp", []);

        app.controller("myCtrl", function ($scope, $http) {

            $scope.backurl = 'http://localhost:8080';

            $scope.iconoDefault = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACvUlEQVQ4jX3T20tUcRAH8O/8ztl117Pretk9665tZVtWW0lgtgRGmC9GBpFUQikUFBRFFyLozX+hG6J0D30wiHxR6CUTu1BtD9JNM0w0V9dbarqtnvObHkwpM+dtGD4MM/P7Ef6IyvqQddDu3U7gcoALAHh/l6IgaiFJ9xP+8ec1WyIzpxtXJ13d1TlNc/hMQ5FXCuMigAoG3Fg8YgBuSkm3ki32QihmHc1hU8xcB2gfAPoPBgBINg2fY+WHrYFi5fHnBwfUyvqQdUiYlwAqXQoyGFKacGt+ZW/oZK7XsTzRMRwJqzFN3ykkH17QBcw8nwtS2GF1IaSHuShYRlkpQfw0JpN8zmCBKpgrAGQAALOEIiwccOWw37kKLlsGklQ7Um06Aq41pGsBoQgVzBJWxYY0m2ezCkbBbFcJd7KP96w7xhu828iuaovuwmQDQ5NRU9eyFKc1NaAC0BkMzerkstwLvN6TL5baRe9Yp5wxE+R1BECkaGJu5pAnzGvdeUvi/h/d/D72mv0pQQIAUxrTAkA/GMhKCZKg//svI22yqeOu3OgNi2SLg2ZH6e1TCWgBUB43Jv9BDMb3eIxf9DRx+1CEd+ccoeWuHAKA4ako2ocjT1UQ3SMSxW39zzzhZcWcZtcxEh9Az1gHtw9F0P39E2c6VqBs03nhc2YTACSMOFq+Pur7MPC6Vs3Q0Dw4Lu78mB690PCxmicSIxhPjMCmapydvhGlG05RMD2XVGGhuDHJ/RNdeNr1UL6NNt8YN9+8JADYX5/pOZF/7bICcfDBuyuUbtdlml0nhzUNFsVKkiUSZpzH4oNicOqbOTU9UQuFzlaVtI7O3/pN3xN3Y8ftc7GJ7qPMnMmQf71GACBBUSFFjanIy1UlraPAgo9zvDrPovqcYUHyEEA7wPDPSvQSqJlI1qVr4lVlYbMxZ34BeHEn8QqSwzsAAAAASUVORK5CYII=";

            $scope.connected = false;
            $scope.dbInitialState = true;

            $scope.endPoints = [
                {
                    controller: 'user Controller',
                    name: 'users',
                    link: $scope.backurl + '/backend/users',
                    method: 'GET',
                    description: 'Todos los usuarios',
                    url: $scope.backurl + '/backend/users',
                    data: {},
                    result: '...',

                },
                {
                    controller: 'user Controller',
                    name: 'users/{id}',
                    method: 'GET',
                    link: $scope.backurl + '/backend/users/1',
                    description: 'Un usuario a partir de su id',
                    url: $scope.backurl + '/backend/users/',
                    data: { id: 1 },
                    result: '...',

                },
                {
                    controller: 'user Controller',
                    name: 'users/email/{eMail}',
                    method: 'GET',
                    description: 'Un usuario a partir de su nombre',
                    link: $scope.backurl + '/backend/users/email/johnMail',
                    url: $scope.backurl + '/backend/users/email/',
                    data: { email: 'john@mail' },
                    result: '...',

                },
                {
                    controller: 'user Controller',
                    name: 'users',
                    method: 'POST',
                    description: 'Nuevo usuario',
                    curl: 'curl -v -X POST ' +$scope.backurl + '/backend/users -H "Content-Type:application/json" -d \'{"name": "john", "city":"London", "eMail": "johnMail"}\'',
                    url: $scope.backurl + '/backend/users/',
                    data: { name: 'John', city: 'Barcelona', eMail: 'john@mail' },
                    result: '...',

                },
                {
                    controller: 'user Controller',
                    name: 'users/{id}',
                    method: 'PUT',
                    description: 'Actualiza usuario',
                    curl: 'curl -v -X PUT ' +$scope.backurl + '/backend/users/1 -d \'{"name": "john", "city":"London", "eMail": "john@mail"}\'',
                    url: $scope.backurl + '/backend/users/',
                    data: { id: '', name: '', city: '', eMail: '' },
                    result: '...',
                },
                {
                    controller: 'user Controller',
                    name: 'users/{id}',
                    method: 'DELETE',
                    description: 'Borra usuario',
                    curl: 'curl -v -X DELETE ' +$scope.backurl + '/backend/users/1',
                    url: $scope.backurl + '/backend/users/',
                    data: { id: '' },
                    result: '...',
                    //todo: '>> el usuario ha sido eliminado.'
                },
                {
                    controller: 'registry Controller',
                    name: 'registries',
                    method: 'GET',
                    description: 'Todos los registros',
                    link: $scope.backurl + '/backend/registries',
                    url: $scope.backurl + '/backend/registries',
                    data: {},
                    result: '...',
                },
                {
                    controller: 'registry Controller',
                    name: 'registries/{id}',
                    method: 'GET',
                    description: 'Un registro a partir de su id',
                    link: $scope.backurl + '/backend/registries/1',
                    url: $scope.backurl + '/backend/registries/',
                    data: { id: '1' },
                    result: '...',

                },
                {
                    controller: 'registry Controller',
                    name: 'registries/{id}',
                    method: 'POST',
                    description: 'Nuevo registro a partir de su titulo, tipo de medio, autor y año de produccion.',
                    curl: 'curl -X POST ' +$scope.backurl + '/backend/registries/ -d \'{ title: "The Hobbit", media: "book", author: "J. R. R. Tolkien", year: "1937" }\'',
                    url: $scope.backurl + '/backend/registries/',
                    data: { title: 'The Hobbit', media: 'book', author: 'J. R. R. Tolkien', year: '1937' },
                    result: '...',
                },
                {
                    controller: 'registry Controller',
                    name: 'registries/{id}',
                    method: 'PUT',
                    description: 'Modifica registro a partir de su id',
                    curl: 'curl -X PUT ' +$scope.backurl + '/backend/registries/1 -d \'{title: "The Hobbit", media: "film saga", autor: "Petter Jackson", "year": "2012"}\'',
                    url: $scope.backurl + '/backend/registries/',
                    data: { id: '', title: '', media: '', autor: '', year: '' },
                    result: '...',

                },
                {
                    controller: 'registry Controller',
                    name: 'registries/{id}',
                    method: 'DELETE',
                    description: 'Elimina registro a partir de su id',
                    link: $scope.backurl + '/backend/registries/1',
                    url: $scope.backurl + '/backend/registries/',
                    data: { id: '' },
                    result: '...',

                },
                {
                    controller: '(user_registry) assessment Controller Controller',
                    name: 'assessments/user/{id}',
                    method: 'GET',
                    description: 'Lista de valoraciones de un usuario',
                    link: $scope.backurl + '/backend/assessments/user/1',
                    url: $scope.backurl + '/backend/assessments/user/',
                    data: { id: 1 },
                    result: '...',
                },
                {
                    controller: '(user_registry) assessment Controller Controller',
                    name: 'assessments/{id}',
                    method: 'GET',
                    description: 'Una valoración a partir de su id',
                    link: $scope.backurl + '/backend/assessments/1',
                    url: $scope.backurl + '/backend/assessments/',
                    data: { id: '1' },
                    result: '...',
                },
                {
                    controller: '(user_registry) assessment Controller Controller',
                    name: 'assessments/add',
                    method: 'POST',
                    description: 'Nueva valoración de un usuario para un registro. Parametros: registry, user,  fav -ranquing favorito (entero), rec -ranquing recomendable (entero)',
                    curl: 'curl -v -X POST ' +$scope.backurl + '/backend/assessments -H "Content-Type:application/json" -d \'{"registry": 79, "user": 1, "notes": "Muy recomendable.", "favorito": 1, "recommend": 2}\'',
                    url: $scope.backurl + '/backend/assessments',
                    data: { userId: '1', registryId: '90', favourite: '4', recommend: '4', notes: 'Muy recomendable' },
                    result: '...',
                },
                {
                    controller: '(user_registry) assessment Controller Controller',
                    name: 'assessments/update',
                    method: 'PUT',
                    description: 'Actualiza valores de favorito y recomendable de un usuario para un registro. Parametros: registry (id), userId, (id), fav -ranquing favourite (entero), rec -ranquing recommend (entero)',
                    curl: 'curl ' +$scope.backurl + '/backend/assessments/update -d \'{"registry": 79, "user": 1, "notes": "Muy recomendable.", "favorito": 1, "recommend": 2}\'',
                    url: $scope.backurl + '/backend/assessments/',
                    data: { id: '', favourite: '', recommend: '', notes: '' },
                    result: '...',
                }

            ]

            $scope.lanzaConsulta = (element) => {

                return $http({
                    method: element.method,
                    url: element.data.id ? element.url + element.data.id : element.data.email ? element.url + element.data.email : element.url,
                    //headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    transformRequest: function (obj) { return obj; },
                    data: JSON.stringify(element.data)
                });


            };

            $scope.testea = function (element) {
                $scope.lanzaConsulta(element).then(
                    (res) => { element.result = res.data },
                    (err) => { element.result = err.data.message }
                )

            }

            $scope.preLoaderUser = {
                all: {
                    method: 'GET',
                    url: $scope.backurl + '/backend/users',
                    data: {},
                    result: '...',
                },
                one: {
                    method: 'POST',
                    url: $scope.backurl + '/backend/users/',
                    data: { name: 'John', city: 'Barcelona', eMail: 'john@mail' },
                    result: '...',
                }
            }

            $scope.preLoaderRegistry = {
                all: {
                    method: 'GET',
                    url: $scope.backurl + '/backend/registries',
                    data: {},
                    result: '...',
                },
                one: {
                    method: 'POST',
                    url: $scope.backurl + '/backend/registries/',
                    data: { title: 'The Hobbit', media: 'book', author: 'J. R. R. Tolkien', year: '1937' },
                    result: '...',
                }
            }


            //comprueba si hay conexion y si hay juego de datos. si no, se ofrece la acción de inicar las tablas
            $scope.preLoad = function (element) {
                console.log(element)
                $scope.lanzaConsulta(element.all).then(
                    (res) => {
                        console.log(res);
                        $scope.connected = true;

                        res.data.content.length == 0 ? $scope.dbInitialState = true : $scope.dbInitialState = false;
                    },
                    (err) => {
                        console.log('no hay conexion? err: ', err);
                        if (err.status == -1) {
                            element.result = 'status -1';

                        } else {

                            element.result = err
                        }
                    }
                )

            }
            $scope.informa = function (res) {
                console.log('se ha generado un usuario: ', res)
            }
            $scope.changeDbInitialState = function (res) {
                $scope.dbInitialState = false;
            }
            $scope.rellenaDatos = function () {

                $scope.lanzaConsulta($scope.preLoaderUser.one).then((res) => $scope.informa(res))
                $scope.lanzaConsulta($scope.preLoaderRegistry.one).then((res) => $scope.informa(res))
                $scope.dbInitialState = false;
            }
            $scope.preLoad($scope.preLoaderUser);
            $scope.preLoad($scope.preLoaderRegistry);



        });
    </script>
</head>


<body>
    <div ng-app="myApp" ng-controller="myCtrl" class="container-fluid">

        <div class=container ng-if="connected && dbInitialState==false">
            <div ng-repeat="caso in endPoints" class=row>
                <h2>{{caso.nom}}</h2>
                <div class=col-12>
                    <div class=card>
                        <h5 class="card-title" style="white-space: nowrap;text-overflow: ellipsis">
                            {{ caso.name }}
                            <span style="opacity: 50%; font-style: italic; font-weight: bold;">({{caso.method}})</span>
                            <span
                                style="white-space: nowrap; overflow:hidden; text-overflow: ellipsis; clear: right; float:right; margin:0">{{caso.controller.toUpperCase()}}</span>
                        </h5>
                        <p>
                            <img src="{{caso.icon?caso.icon:iconoDefault}}" alt="icono"
                                style="width: 12px; height: 12px; clear: right; float:left;margin:.5rem .5rem 0 0">

                            <a href="{{caso.link}}"
                                style="white-space: nowrap; overflow:hidden; text-overflow: ellipsis; margin:0"
                                title={{caso.link}}>{{caso.link}}</a>

                            <a ng-if='caso.link' href="{{caso.link}}"
                                style="white-space: nowrap; overflow:hidden; text-overflow: ellipsis; clear: right; float:right; margin:0"
                                title={{caso.link}} target="_blanck">new window</a>
                            <a ng-if="caso.curl"
                                style="white-space: nowrap; overflow:hidden; text-overflow: ellipsis; margin:0; color: green">{{caso.curl}}</a>
                        </p>
                        <div class=marginAbajo>{{ caso.description }}</div>

                        <div class="row">
                            <div ng-repeat='(key, value) in caso.data' class='marginAbajo col-4'
                                style='overflow: hidden; display: inline;'>
                                {{key}}: <input ng-model='caso.data[key]' style="width: auto; float: right;" />
                            </div>
                        </div>

                        <input class='btn btn-outline-secondary marginAbajo' type="button" ng-click="testea(caso)"
                            value="test"></input>
                        <code>{{caso.result}}</code>

                        <p ng-if=caso.todo class=todo>TODO: {{ caso.todo }}</p>

                    </div>
                </div>
            </div>

        </div>
        <!-- Si no hay conexion -->
        <div class=container ng-if='!connected'>
            <div class=row>
                <div class=col-12>
                    <div class=card>
                        <code>
                            Revise la conexion con backend. backurl: {{backurl}}
                        </code>
                    </div>
                </div>
            </div>
        </div>

        <!-- Si no hay datos de usuarios o registros -->
        <div class=container ng-if='connected && dbInitialState'>
            <div class=row>
                <div class=col-12>
                    <div class=card>
                        <code>
                            La base de datos parece vacía.
                        </code>
                        <hr>
                        <div class=row>
                            <div class=col-6>

                                <button class='btn btn-primary col-12'
                                    ng-click="changeDbInitialState()">Continuar</button>
                            </div>
                            <div class=col-6>
                                <button class='btn btn-success col-12' ng-click="rellenaDatos()">Crear datos de
                                    prueba</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
</html>